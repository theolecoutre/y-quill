{"version":3,"file":"y-quill.cjs","sources":["../src/y-quill.js"],"sourcesContent":["/**\n * @module bindings/quill\n */\n\n import * as Y from 'yjs' // eslint-disable-line\n import { Awareness } from 'y-protocols/awareness.js' // eslint-disable-line\n \n /**\n  * Removes the pending '\\n's if it has no attributes.\n  */\n export const normQuillDelta = delta => {\n   if (delta.length > 0) {\n     const d = delta[delta.length - 1]\n     const insert = d.insert\n     if (d.attributes === undefined && insert !== undefined && insert.slice(-1) === '\\n') {\n       delta = delta.slice()\n       let ins = insert.slice(0, -1)\n       while (ins.slice(-1) === '\\n') {\n         ins = ins.slice(0, -1)\n       }\n       delta[delta.length - 1] = { insert: ins }\n       if (ins.length === 0) {\n         delta.pop()\n       }\n       return delta\n     }\n   }\n   return delta\n }\n \n /**\n  * @param {any} quillCursors\n  */\n const updateCursor = (quillCursors, aw, clientId, doc, type) => {\n   try {\n     if (aw && aw.cursor && clientId !== doc.clientID) {\n       const user = aw.user || {}\n       const color = user.color || '#ffa500'\n       const name = user.name || `User: ${clientId}`\n       quillCursors.createCursor(clientId.toString(), name, color)\n       const anchor = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.anchor), doc)\n       const head = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.head), doc)\n       if (anchor && head && anchor.type === type) {\n         quillCursors.moveCursor(clientId.toString(), { index: anchor.index, length: head.index - anchor.index })\n       }\n     } else {\n       quillCursors.removeCursor(clientId.toString())\n     }\n   } catch (err) {\n     console.error(err)\n   }\n }\n \n export class QuillBinding {\n   /**\n    * @param {Y.Text} type\n    * @param {any} quill\n    * @param {Awareness} [awareness]\n    */\n   constructor (type, quill, awareness) {\n \n     console.log(\"constructor\");\n \n     const doc = /** @type {Y.Doc} */ (type.doc)\n     this.type = type\n     this.doc = doc\n     this.quill = quill\n     const quillCursors = quill.getModule('cursors') || null\n     this.quillCursors = quillCursors\n     // This object contains all attributes used in the quill instance\n     this._negatedUsedFormats = {}\n     this.awareness = awareness\n     this._awarenessChange = ({ added, removed, updated }) => {\n       const states = /** @type {Awareness} */ (awareness).getStates()\n       added.forEach(id => {\n         updateCursor(quillCursors, states.get(id), id, doc, type)\n       })\n       updated.forEach(id => {\n         updateCursor(quillCursors, states.get(id), id, doc, type)\n       })\n       removed.forEach(id => {\n         quillCursors.removeCursor(id.toString())\n       })\n     }\n     /**\n      * @param {Y.YTextEvent} event\n      */\n     this._typeObserver = event => {\n       if (event.transaction.origin !== this) {\n         const eventDelta = event.delta\n         // We always explicitly set attributes, otherwise concurrent edits may\n         // result in quill assuming that a text insertion shall inherit existing\n         // attributes.\n         const delta = []\n         for (let i = 0; i < eventDelta.length; i++) {\n           const d = eventDelta[i]\n           if (d.insert !== undefined) {\n             delta.push(Object.assign({}, d, { attributes: Object.assign({}, this._negatedUsedFormats, d.attributes || {}) }))\n           } else {\n             delta.push(d)\n           }\n         }\n         quill.updateContents(delta, this)\n       }\n     }\n     type.observe(this._typeObserver)\n     this._quillObserver = (eventType, delta, state, origin) => {\n \n       console.log(\"quill observer\", eventType, delta, state, origin)\n \n       if (delta && delta.ops) {\n         // update content\n         const ops = delta.ops\n         ops.forEach(op => {\n           if (op.attributes !== undefined) {\n             for (let key in op.attributes) {\n               if (this._negatedUsedFormats[key] === undefined) {\n                 this._negatedUsedFormats[key] = false\n               }\n             }\n           }\n         })\n         if (origin !== this) {\n           doc.transact(() => {\n             type.applyDelta(ops)\n           }, this)\n         }\n       }\n       // always check selection\n       if (awareness && quillCursors) {\n         const sel = quill.getSelection()\n         const aw = /** @type {any} */ (awareness.getLocalState())\n         if (sel === null) {\n           if (awareness.getLocalState() !== null) {\n             awareness.setLocalStateField('cursor', /** @type {any} */ (null))\n           }\n         } else {\n           const anchor = Y.createRelativePositionFromTypeIndex(type, sel.index)\n           const head = Y.createRelativePositionFromTypeIndex(type, sel.index + sel.length)\n           if (!aw || !aw.cursor || !Y.compareRelativePositions(anchor, aw.cursor.anchor) || !Y.compareRelativePositions(head, aw.cursor.head)) {\n             awareness.setLocalStateField('cursor', {\n               anchor,\n               head\n             })\n           }\n         }\n         // update all remote cursor locations\n         awareness.getStates().forEach((aw, clientId) => {\n           updateCursor(quillCursors, aw, clientId, doc, type)\n         })\n       }\n     }\n     quill.on('editor-change', this._quillObserver)\n     // This indirectly initializes _negatedUsedFormats.\n     // Make sure that this call this after the _quillObserver is set.\n     quill.setContents(type.toDelta(), this)\n     // init remote cursors\n     if (quillCursors !== null && awareness) {\n       awareness.getStates().forEach((aw, clientId) => {\n         updateCursor(quillCursors, aw, clientId, doc, type)\n       })\n       awareness.on('change', this._awarenessChange)\n     }\n   }\n   destroy () {\n     this.type.unobserve(this._typeObserver)\n     this.quill.off('editor-change', this._quillObserver)\n     if (this.awareness) {\n       this.awareness.off('change', this._awarenessChange)\n     }\n   }\n }\n "],"names":["Y"],"mappings":"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"}